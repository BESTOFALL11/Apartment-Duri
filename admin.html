<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Apartment Duri</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: {
                        brand: {
                            dark: '#1E293B',
                            primary: '#0284C7',
                            secondary: '#14B8A6',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-sky-50 via-slate-50 to-stone-50">

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass rounded-3xl p-8 md:p-12 w-full max-w-md shadow-xl">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-brand-dark mb-2">Apartment Duri</h1>
                <p class="text-slate-500">Admin Panel</p>
            </div>

            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-2">Email</label>
                    <input type="email" id="email" required
                        class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-brand-primary focus:ring-2 focus:ring-brand-primary/20 outline-none transition-all"
                        placeholder="duriceka3@gmail.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-2">Password</label>
                    <input type="password" id="password" required
                        class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-brand-primary focus:ring-2 focus:ring-brand-primary/20 outline-none transition-all"
                        placeholder="••••••••">
                </div>
                <button type="submit"
                    class="w-full bg-brand-primary text-white py-4 rounded-xl font-bold hover:bg-sky-600 transition-colors mt-6">
                    Sign In
                </button>
                <p id="loginError" class="text-red-500 text-sm text-center hidden">Invalid credentials</p>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden min-h-screen p-4 md:p-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h1 class="text-2xl font-bold text-brand-dark">Availability Manager</h1>
                    <p class="text-slate-500 text-sm">Manage your apartment bookings</p>
                </div>
                <div class="flex items-center gap-4">
                    <button id="syncBtn"
                        class="flex items-center gap-2 px-4 py-2 bg-emerald-100 text-emerald-700 rounded-xl font-medium hover:bg-emerald-200 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Sync Booking.com
                    </button>
                    <button id="logoutBtn"
                        class="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl font-medium hover:bg-slate-200 transition-colors">
                        Logout
                    </button>
                </div>
            </div>

            <!-- Add Booking Form -->
            <div class="glass rounded-2xl p-6 mb-6 shadow-lg">
                <h2 class="text-lg font-bold text-brand-dark mb-4">Add Manual Booking</h2>
                <form id="addBookingForm" class="flex flex-wrap gap-4 items-end">
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-sm font-medium text-slate-600 mb-2">Check-in Date</label>
                        <input type="date" id="startDate" required
                            class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-brand-primary outline-none">
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-sm font-medium text-slate-600 mb-2">Check-out Date</label>
                        <input type="date" id="endDate" required
                            class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-brand-primary outline-none">
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-sm font-medium text-slate-600 mb-2">Guest Name (optional)</label>
                        <input type="text" id="guestName"
                            class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-brand-primary outline-none"
                            placeholder="Guest name">
                    </div>
                    <button type="submit"
                        class="px-6 py-3 bg-brand-primary text-white rounded-xl font-bold hover:bg-sky-600 transition-colors">
                        Add Booking
                    </button>
                </form>
            </div>

            <!-- Bookings List -->
            <div class="glass rounded-2xl p-6 shadow-lg">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-brand-dark">Current Bookings</h2>
                    <span id="bookingCount" class="text-sm text-slate-500">0 bookings</span>
                </div>
                <div id="bookingsList" class="space-y-3">
                    <!-- Bookings will be rendered here -->
                </div>
                <p id="noBookings" class="text-center text-slate-400 py-8">No bookings yet</p>
            </div>

            <!-- Last Sync Info -->
            <p id="lastSyncInfo" class="text-center text-xs text-slate-400 mt-6"></p>
        </div>
    </div>

    <script>
        // Simple admin credentials (in production, use Firebase Auth)
        const ADMIN_EMAIL = 'duriceka3@gmail.com';
        const ADMIN_PASSWORD = 'duri2024'; // Change this to your preferred password

        // Storage keys
        const STORAGE_KEY = 'apartment_duri_bookings';
        const AUTH_KEY = 'apartment_duri_auth';

        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const adminDashboard = document.getElementById('adminDashboard');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const addBookingForm = document.getElementById('addBookingForm');
        const bookingsList = document.getElementById('bookingsList');
        const noBookings = document.getElementById('noBookings');
        const bookingCount = document.getElementById('bookingCount');
        const syncBtn = document.getElementById('syncBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const lastSyncInfo = document.getElementById('lastSyncInfo');

        // Check if already logged in
        if (localStorage.getItem(AUTH_KEY) === 'true') {
            showDashboard();
        }

        // Login handler
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
                localStorage.setItem(AUTH_KEY, 'true');
                loginError.classList.add('hidden');
                showDashboard();
            } else {
                loginError.classList.remove('hidden');
            }
        });

        // Logout handler
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem(AUTH_KEY);
            loginScreen.classList.remove('hidden');
            adminDashboard.classList.add('hidden');
        });

        // Show dashboard
        function showDashboard() {
            loginScreen.classList.add('hidden');
            adminDashboard.classList.remove('hidden');
            loadBookings();
        }

        // Load bookings from localStorage
        function loadBookings() {
            const bookings = getBookings();
            renderBookings(bookings);
        }

        // Get bookings from storage
        function getBookings() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        }

        // Save bookings to storage
        function saveBookings(bookings) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(bookings));
            // Dispatch storage event for cross-tab sync
            window.dispatchEvent(new StorageEvent('storage', { key: STORAGE_KEY }));
        }

        // Render bookings list
        function renderBookings(bookings) {
            if (bookings.length === 0) {
                bookingsList.innerHTML = '';
                noBookings.classList.remove('hidden');
                bookingCount.textContent = '0 bookings';
                return;
            }

            noBookings.classList.add('hidden');
            bookingCount.textContent = `${bookings.length} booking${bookings.length > 1 ? 's' : ''}`;

            // Sort by start date
            bookings.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            bookingsList.innerHTML = bookings.map(booking => `
        <div class="flex items-center justify-between p-4 bg-white/50 rounded-xl border border-slate-100">
          <div class="flex items-center gap-4">
            <div class="h-10 w-10 rounded-xl flex items-center justify-center ${booking.source === 'booking.com' ? 'bg-blue-100 text-blue-600' : 'bg-emerald-100 text-emerald-600'}">
              ${booking.source === 'booking.com' ?
                    '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>' :
                    '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>'
                }
            </div>
            <div>
              <p class="font-semibold text-brand-dark">${formatDateRange(booking.startDate, booking.endDate)}</p>
              <p class="text-sm text-slate-500">${booking.guestName || (booking.source === 'booking.com' ? 'Booking.com Guest' : 'Direct Booking')}</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="px-2 py-1 text-xs font-medium rounded-full ${booking.source === 'booking.com' ? 'bg-blue-100 text-blue-700' : 'bg-emerald-100 text-emerald-700'}">
              ${booking.source === 'booking.com' ? 'Booking.com' : 'Manual'}
            </span>
            ${booking.source !== 'booking.com' ? `
              <button 
                onclick="deleteBooking('${booking.id}')"
                class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
              </button>
            ` : ''}
          </div>
        </div>
      `).join('');
        }

        // Format date range
        function formatDateRange(start, end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            const options = { month: 'short', day: 'numeric' };
            return `${startDate.toLocaleDateString('en-US', options)} - ${endDate.toLocaleDateString('en-US', options)}, ${endDate.getFullYear()}`;
        }

        // Add booking
        addBookingForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const guestName = document.getElementById('guestName').value;

            if (new Date(endDate) < new Date(startDate)) {
                alert('Check-out date must be after check-in date');
                return;
            }

            const bookings = getBookings();
            bookings.push({
                id: Date.now().toString(),
                startDate,
                endDate,
                guestName: guestName || null,
                source: 'manual',
                createdAt: new Date().toISOString()
            });

            saveBookings(bookings);
            renderBookings(bookings);
            addBookingForm.reset();
        });

        // Delete booking
        function deleteBooking(id) {
            if (!confirm('Are you sure you want to delete this booking?')) return;

            let bookings = getBookings();
            bookings = bookings.filter(b => b.id !== id);
            saveBookings(bookings);
            renderBookings(bookings);
        }

        // Sync from Booking.com
        syncBtn.addEventListener('click', async () => {
            syncBtn.disabled = true;
            syncBtn.innerHTML = `
        <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Syncing...
      `;

            try {
                const ICAL_URL = 'https://ical.booking.com/v1/export?t=ca8fbb03-b908-40b9-bcf9-37121756164d';
                const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(ICAL_URL)}`);
                const icalData = await response.text();

                if (icalData.includes('VCALENDAR')) {
                    const bookingComBookings = parseICalData(icalData);
                    let bookings = getBookings();

                    // Remove old booking.com entries
                    bookings = bookings.filter(b => b.source !== 'booking.com');

                    // Add new ones
                    bookings = [...bookings, ...bookingComBookings];

                    saveBookings(bookings);
                    renderBookings(bookings);

                    lastSyncInfo.textContent = `Last synced: ${new Date().toLocaleString()}`;
                }
            } catch (error) {
                console.error('Sync failed:', error);
                alert('Failed to sync with Booking.com. Please try again.');
            }

            syncBtn.disabled = false;
            syncBtn.innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Sync Booking.com
      `;
        });

        // Parse iCal data
        function parseICalData(icalData) {
            const bookings = [];
            const events = icalData.split('BEGIN:VEVENT');

            events.forEach((event, index) => {
                if (index === 0) return;

                const startMatch = event.match(/DTSTART(?:;VALUE=DATE)?:(\d{8})/);
                const endMatch = event.match(/DTEND(?:;VALUE=DATE)?:(\d{8})/);

                if (startMatch && endMatch) {
                    const startDate = `${startMatch[1].slice(0, 4)}-${startMatch[1].slice(4, 6)}-${startMatch[1].slice(6, 8)}`;
                    const endDateRaw = new Date(
                        parseInt(endMatch[1].slice(0, 4)),
                        parseInt(endMatch[1].slice(4, 6)) - 1,
                        parseInt(endMatch[1].slice(6, 8)) - 1
                    );
                    const endDate = endDateRaw.toISOString().split('T')[0];

                    bookings.push({
                        id: `booking-${index}-${Date.now()}`,
                        startDate,
                        endDate,
                        source: 'booking.com',
                        guestName: null,
                        createdAt: new Date().toISOString()
                    });
                }
            });

            return bookings;
        }
    </script>
</body>

</html>